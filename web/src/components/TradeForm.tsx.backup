import { motion } from 'framer-motion'
import { useState } from 'react'
import { X, Upload, TrendingUp, TrendingDown } from 'lucide-react'
import GradientButton from './GradientButton'
import { api } from '../lib/api'

interface TradeFormProps {
    onClose: () => void
    onSuccess: () => void
    trade?: any
}

const FOREX_PAIRS = ['EURUSD', 'GBPUSD', 'USDJPY', 'USDCHF', 'AUDUSD', 'USDCAD', 'NZDUSD', 'EURJPY', 'GBPJPY', 'EURGBP']
const SESSIONS = ['Asian', 'London', 'New York', 'Sydney']
const TIMEFRAMES = ['M1', 'M5', 'M15', 'M30', 'H1', 'H4', 'D1', 'W1']
const STRATEGIES = ['Breakout', 'Trend Following', 'Reversal', 'Scalping', 'Range Trading', 'News Trading']
const MOODS = [
    { emoji: 'üòä', label: 'Confident' },
    { emoji: 'üòê', label: 'Neutral' },
    { emoji: 'üò∞', label: 'Anxious' },
    { emoji: 'üò§', label: 'Frustrated' },
    { emoji: 'ü§î', label: 'Uncertain' }
]

export default function TradeForm({ onClose, onSuccess, trade }: TradeFormProps) {
    const [formData, setFormData] = useState({
        date: trade?.date ? new Date(trade.date).toISOString().slice(0, 16) : new Date().toISOString().slice(0, 16),
        instrument: trade?.instrument || 'EURUSD',
        direction: trade?.direction || 'long',
        entryPrice: trade?.entryPrice || '',
        exitPrice: trade?.exitPrice || '',
        stopLoss: trade?.stopLoss || '',
        takeProfit: trade?.takeProfit || '',
        lotSize: trade?.lotSize || '',
        notes: trade?.notes || '',
        tags: trade?.tags || [],
        timeframe: trade?.timeframe || 'H1',
        session: trade?.session || 'London',
        mood: '',
        rating: 0
    })
    const [files, setFiles] = useState<FileList | null>(null)
    const [loading, setLoading] = useState(false)

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault()
        setLoading(true)
        try {
            const tradeData = {
                ...formData,
                entryPrice: parseFloat(formData.entryPrice as string),
                exitPrice: formData.exitPrice ? parseFloat(formData.exitPrice as string) : undefined,
                stopLoss: formData.stopLoss ? parseFloat(formData.stopLoss as string) : undefined,
                takeProfit: formData.takeProfit ? parseFloat(formData.takeProfit as string) : undefined,
                lotSize: formData.lotSize ? parseFloat(formData.lotSize as string) : undefined,
            }

            if (trade) {
                await api.patch(`/trades/${trade._id}`, tradeData)
            } else {
                await api.post('/trades', tradeData)
            }

            if (files && files.length > 0) {
                const formDataFiles = new FormData()
                Array.from(files).forEach(file => formDataFiles.append('screenshots', file))
                await api.post('/trades/upload', formDataFiles)
            }

            onSuccess()
            onClose()
        } catch (err) {
            console.error('Failed to save trade:', err)
        } finally {
            setLoading(false)
        }
    }

    return (
        <div 
            style={{
                position: 'fixed',
                inset: '0',
                zIndex: 50,
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                backdropFilter: 'blur(4px)',
                overflowY: 'auto'
            }}
            onClick={onClose}
        >
            <div style={{ 
                minHeight: '100vh', 
                display: 'flex', 
                alignItems: 'center', 
                justifyContent: 'center', 
                padding: '16px' 
            }}>
                <motion.div
                    initial={{ scale: 0.95, opacity: 0 }}
                    animate={{ scale: 1, opacity: 1 }}
                    exit={{ scale: 0.95, opacity: 0 }}
                    transition={{ duration: 0.2 }}
                    style={{
                        backgroundColor: '#171717',
                        borderRadius: '12px',
                        border: '1px solid #262626',
                        boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.5)',
                        width: '90vw',
                        maxWidth: '1400px',
                        height: '90vh',
                        maxHeight: '900px',
                        display: 'flex',
                        flexDirection: 'column'
                    }}
                    onClick={(e) => e.stopPropagation()}
                >
                    <div style={{ 
                        padding: '24px', 
                        overflowY: 'auto', 
                        flex: 1 
                    }}>
                <div style={{ 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'space-between', 
                    marginBottom: '24px',
                    position: 'sticky',
                    top: 0,
                    backgroundColor: '#171717',
                    zIndex: 10,
                    paddingBottom: '16px'
                }}>
                    <h2 style={{ fontSize: '24px', fontWeight: 'bold' }}>{trade ? 'Edit Trade' : 'New Trade'}</h2>
                    <button
                        onClick={onClose}
                        style={{
                            color: '#a3a3a3',
                            padding: '8px',
                            backgroundColor: 'transparent',
                            border: 'none',
                            borderRadius: '4px',
                            cursor: 'pointer',
                            transition: 'all 0.2s'
                        }}
                        onMouseOver={(e) => {
                            e.currentTarget.style.color = '#ffffff'
                            e.currentTarget.style.backgroundColor = '#262626'
                        }}
                        onMouseOut={(e) => {
                            e.currentTarget.style.color = '#a3a3a3'
                            e.currentTarget.style.backgroundColor = 'transparent'
                        }}
                    >
                        <X size={24} />
                    </button>
                </div>

                <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                    {/* Row 1: Basic Info */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: '16px' }}>
                        <div>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', marginBottom: '8px' }}>Date & Time</label>
                            <input
                                type="datetime-local"
                                value={formData.date}
                                onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                                style={{
                                    width: '100%',
                                    padding: '8px 16px',
                                    backgroundColor: '#262626',
                                    border: '1px solid #404040',
                                    borderRadius: '8px',
                                    color: '#fff',
                                    fontSize: '14px'
                                }}
                                required
                            />
                        </div>
                        <div>
                            <label style={{ display: 'block', fontSize: '14px', fontWeight: '500', marginBottom: '8px' }}>Pair</label>
                            <select
                                value={formData.instrument}
                                onChange={(e) => setFormData({ ...formData, instrument: e.target.value })}
                                style={{
                                    width: '100%',
                                    padding: '8px 16px',
                                    backgroundColor: '#262626',
                                    border: '1px solid #404040',
                                    borderRadius: '8px',
                                    color: '#fff',
                                    fontSize: '14px'
                                }}
                            >
                                {FOREX_PAIRS.map(pair => <option key={pair} value={pair}>{pair}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-2">Direction</label>
                            <div className="flex gap-2">
                                <button
                                    type="button"
                                    onClick={() => setFormData({ ...formData, direction: 'long' })}
                                    className={`flex-1 py-2 px-4 rounded-lg border transition-all ${formData.direction === 'long'
                                            ? 'bg-green-500/20 border-green-500 text-green-500'
                                            : 'border-neutral-700 hover:border-green-500'
                                        }`}
                                >
                                    <TrendingUp className="inline mr-2" size={18} />
                                    Long
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setFormData({ ...formData, direction: 'short' })}
                                    className={`flex-1 py-2 px-4 rounded-lg border transition-all ${formData.direction === 'short'
                                            ? 'bg-red-500/20 border-red-500 text-red-500'
                                            : 'border-neutral-700 hover:border-red-500'
                                        }`}
                                >
                                    <TrendingDown className="inline mr-2" size={18} />
                                    Short
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Row 2: Price Levels */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label className="block text-sm font-medium mb-2">Entry Price *</label>
                            <input
                                type="number"
                                step="0.00001"
                                value={formData.entryPrice}
                                onChange={(e) => setFormData({ ...formData, entryPrice: e.target.value })}
                                className="w-full px-4 py-2 bg-neutral-800 border border-neutral-700 rounded-lg focus:outline-none focus:border-brand"
                                required
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-2">Exit Price</label>
                            <input
                                type="number"
                                step="0.00001"
                                value={formData.exitPrice}
                                onChange={(e) => setFormData({ ...formData, exitPrice: e.target.value })}
                                className="w-full px-4 py-2 bg-neutral-800 border border-neutral-700 rounded-lg focus:outline-none focus:border-brand"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-2">Stop Loss</label>
                            <input
                                type="number"
                                step="0.00001"
                                value={formData.stopLoss}
                                onChange={(e) => setFormData({ ...formData, stopLoss: e.target.value })}
                                className="w-full px-4 py-2 bg-neutral-800 border border-neutral-700 rounded-lg focus:outline-none focus:border-brand"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-2">Take Profit</label>
                            <input
                                type="number"
                                step="0.00001"
                                value={formData.takeProfit}
                                onChange={(e) => setFormData({ ...formData, takeProfit: e.target.value })}
                                className="w-full px-4 py-2 bg-neutral-800 border border-neutral-700 rounded-lg focus:outline-none focus:border-brand"
                            />
                        </div>
                    </div>

                    {/* Row 3: Trading Details */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label className="block text-sm font-medium mb-2">Lot Size</label>
                            <input
                                type="number"
                                step="0.01"
                                value={formData.lotSize}
                                onChange={(e) => setFormData({ ...formData, lotSize: e.target.value })}
                                className="w-full px-4 py-2 bg-neutral-800 border border-neutral-700 rounded-lg focus:outline-none focus:border-brand"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-2">Timeframe</label>
                            <select
                                value={formData.timeframe}
                                onChange={(e) => setFormData({ ...formData, timeframe: e.target.value })}
                                className="w-full px-4 py-2 bg-neutral-800 border border-neutral-700 rounded-lg focus:outline-none focus:border-brand"
                            >
                                {TIMEFRAMES.map(tf => <option key={tf} value={tf}>{tf}</option>)}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-2">Session</label>
                            <select
                                value={formData.session}
                                onChange={(e) => setFormData({ ...formData, session: e.target.value })}
                                className="w-full px-4 py-2 bg-neutral-800 border border-neutral-700 rounded-lg focus:outline-none focus:border-brand"
                            >
                                {SESSIONS.map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                        </div>
                    </div>

                    {/* Strategy Tags */}
                    <div>
                        <label className="block text-sm font-medium mb-2">Strategy</label>
                        <div className="flex flex-wrap gap-2">
                            {STRATEGIES.map(strategy => (
                                <motion.button
                                    key={strategy}
                                    type="button"
                                    whileHover={{ scale: 1.05 }}
                                    whileTap={{ scale: 0.95 }}
                                    onClick={() => {
                                        const tags = formData.tags || []
                                        setFormData({
                                            ...formData,
                                            tags: tags.includes(strategy)
                                                ? tags.filter((t: string) => t !== strategy)
                                                : [...tags, strategy]
                                        })
                                    }}
                                    className={`px-4 py-2 rounded-lg border transition-all ${formData.tags?.includes(strategy)
                                            ? 'bg-brand/20 border-brand text-brand'
                                            : 'border-neutral-700 hover:border-brand'
                                        }`}
                                >
                                    {strategy}
                                </motion.button>
                            ))}
                        </div>
                    </div>

                    {/* Psychology Section */}
                    <div>
                        <label className="block text-sm font-medium mb-2">How did you feel?</label>
                        <div className="flex gap-3">
                            {MOODS.map(mood => (
                                <motion.button
                                    key={mood.label}
                                    type="button"
                                    whileHover={{ scale: 1.2 }}
                                    whileTap={{ scale: 0.9 }}
                                    onClick={() => setFormData({ ...formData, mood: mood.label })}
                                    className={`text-3xl p-3 rounded-lg border transition-all ${formData.mood === mood.label
                                            ? 'border-brand bg-brand/10'
                                            : 'border-neutral-700 hover:border-brand'
                                        }`}
                                    title={mood.label}
                                >
                                    {mood.emoji}
                                </motion.button>
                            ))}
                        </div>
                    </div>

                    {/* Notes */}
                    <div>
                        <label className="block text-sm font-medium mb-2">Trade Notes</label>
                        <textarea
                            value={formData.notes}
                            onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                            rows={4}
                            className="w-full px-4 py-2 bg-neutral-800 border border-neutral-700 rounded-lg focus:outline-none focus:border-brand resize-none"
                            placeholder="What was your thesis? How did you manage the trade?"
                        />
                    </div>

                    {/* File Upload */}
                    <div>
                        <label className="block text-sm font-medium mb-2">Screenshots</label>
                        <div className="border-2 border-dashed border-neutral-700 rounded-lg p-6 text-center hover:border-brand transition-colors">
                            <Upload className="mx-auto mb-2 text-neutral-500" size={32} />
                            <input
                                type="file"
                                multiple
                                accept="image/*"
                                onChange={(e) => setFiles(e.target.files)}
                                className="hidden"
                                id="file-upload"
                            />
                            <label
                                htmlFor="file-upload"
                                className="cursor-pointer text-brand hover:underline"
                            >
                                Click to upload trade charts
                            </label>
                            <p className="text-neutral-500 text-sm mt-1">
                                {files ? `${files.length} file(s) selected` : 'PNG, JPG up to 5MB'}
                            </p>
                        </div>
                    </div>

                    {/* Actions */}
                    <div className="flex gap-4 justify-end pt-4">
                        <button
                            type="button"
                            onClick={onClose}
                            className="px-6 py-3 bg-neutral-800 rounded-lg hover:bg-neutral-700 transition-colors"
                        >
                            Cancel
                        </button>
                        <GradientButton type="submit" className="px-6 py-3">
                            {loading ? 'Saving...' : trade ? 'Update Trade' : 'Save Trade'}
                        </GradientButton>
                    </div>
                </form>
                    </div>
                </motion.div>
            </div>
        </div>
    )
}
